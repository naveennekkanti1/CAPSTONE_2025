<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cart Payment | RapiACT!</title>
    <link rel="icon" type="image/jpg" href="{{ url_for('static', filename='images/logo.jpg') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    {% extends 'base.html' %}
{% block title %}Cart Payment | RapiACT!{% endblock %}

{% block head %}
<style>
    :root {
        --primary-dark: #1a237e;
        --primary-light: #5c6bc0;
        --accent-color: #7c4dff;
    }

    .two-column-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-top: 20px;
    }

    .column {
        flex: 1;
        min-width: 300px;
    }

    .section {
        background-color: rgba(255, 255, 255, 0.95);
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        color: #333;
        margin-bottom: 30px;
    }

    .qr-code-container {
        display: flex;
        justify-content: center;
        margin: 20px 0;
    }

    .qr-code {
        width: 250px;
        height: 250px;
        padding: 15px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .payment-instructions {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        margin: 20px 0;
    }

    .payment-instructions ol {
        padding-left: 20px;
    }

    .payment-instructions li {
        margin-bottom: 10px;
    }

    .payment-status {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 15px;
        border-radius: 10px;
        font-weight: bold;
        margin-top: 20px;
    }

    .payment-pending {
        background-color: #fff3cd;
        color: #856404;
    }

    .payment-success {
        background-color: #d4edda;
        color: #155724;
    }

    .cart-items-container {
        max-height: 300px;
        overflow-y: auto;
        padding-right: 5px;
    }

    .cart-item {
        display: flex;
        align-items: center;
        padding: 15px;
        border-bottom: 1px solid #eee;
    }

    .cart-item-image {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 8px;
        margin-right: 15px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .cart-item-details {
        flex-grow: 1;
    }

    .cart-item-details h5 {
        margin: 0 0 5px 0;
        color: var(--primary-dark);
    }

    .cart-item-details p {
        margin: 0 0 5px 0;
        color: #666;
    }

    .order-summary {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #eee;
    }

    .summary-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
    }

    .total-section {
        display: flex;
        justify-content: space-between;
        font-size: 1.2rem;
        font-weight: bold;
        margin-top: 20px;
        padding: 15px 0;
        border-top: 2px solid var(--primary-light);
    }

    .delivery-info {
        background-color: #e8f5e9;
        padding: 15px;
        border-radius: 10px;
        margin: 20px 0;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
    }

    .form-control {
        width: 100%;
        padding: 10px;
        border: 1px solid #ced4da;
        border-radius: 5px;
    }

    .text-muted {
        color: #6c757d;
        font-size: 0.9rem;
        margin-top: 5px;
    }

    .btn-submit {
        background: linear-gradient(90deg, var(--primary-dark), var(--accent-color));
        color: white;
        border: none;
        padding: 15px 20px;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        width: 100%;
        margin-top: 20px;
        transition: all 0.3s ease;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }

    .btn-submit:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(124, 77, 255, 0.4);
    }

    /* For smaller screens */
    @media (max-width: 768px) {
        .two-column-container {
            flex-direction: column;
        }

        .column {
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-header">
    <h2>Cart Payment</h2>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}
{% endwith %}

<div class="two-column-container">
    <!-- Left Column - QR Code -->
    <div class="column">
        <div class="section">
            <h4>Scan the QR Code to Pay</h4>
            <div class="qr-code-container">
                <div class="qr-code">
                    <img src="{{ qr_code }}" alt="Payment QR Code" style="width: 100%; height: 100%;">
                </div>
            </div>
            
            <div class="payment-instructions">
                <h4>Payment Instructions:</h4>
                <ol>
                    <li>Open your UPI app (GPay, PhonePe, BHIM, etc.)</li>
                    <li>Scan the QR code shown above</li>
                    <li>Complete the payment for <strong>₹{{ total_amount }}</strong></li>
                    <li>Note down the UTR/Transaction ID</li>
                    <li>Submit the UTR/Transaction ID below</li>
                </ol>
            </div>
            
            <div class="payment-status payment-pending">
                <i class="fas fa-clock"></i> Payment Status: Pending
            </div>
        </div>
    </div>
    
    <!-- Right Column - Cart Details & Payment Form -->
    <div class="column">
        <div class="section">
            <h4>Order Details</h4>
            
            <div class="cart-items-container" id="cart-items">
                <!-- Cart items will be dynamically loaded here -->
            </div>
            
            <div class="order-summary">
                <div class="summary-item">
                    <span class="summary-label">Subtotal:</span>
                    <span class="summary-value" id="subtotal">₹{{ subtotal }}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Shipping:</span>
                    <span class="summary-value" id="shipping">₹{{ shipping_fee }}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Tax (GST):</span>
                    <span class="summary-value" id="tax">₹{{ tax }}</span>
                </div>
            </div>
            
            <div class="total-section">
                <span class="total-label">Total Amount:</span>
                <span class="total-amount" id="total-amount">₹{{ total_amount }}</span>
            </div>
            
            <div class="delivery-info">
                <h5><i class="fas fa-truck"></i> Delivery Information</h5>
                <p>Your order will be delivered to your registered address within 3-5 business days after payment confirmation.</p>
            </div>
            
            <div id="payment-form">
                <input type="hidden" id="order_id" name="order_id" value="{{ order_id }}">
                
                <div class="form-group">
                    <label for="utr_id" class="form-label">UTR/Transaction ID</label>
                    <input type="text" class="form-control" id="utr_id" name="utr_id" required>
                    <small class="text-muted">Enter the UTR/Transaction ID you received after making the payment</small>
                </div>
                
                <button type="button" class="btn-submit" id="submit-payment">
                    <i class="fas fa-check-circle"></i> Submit Payment
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Loading Spinner -->
<div class="spinner-overlay" id="spinner-overlay">
    <div class="spinner"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Loading spinner functions
    function showSpinner() {
        document.getElementById('spinner-overlay').classList.add('show');
    }
    
    function hideSpinner() {
        document.getElementById('spinner-overlay').classList.remove('show');
    }

    // Load cart items from localStorage when page loads
    document.addEventListener('DOMContentLoaded', function() {
        loadCartItems();
        
        // Add submit event listener
        document.getElementById('submit-payment').addEventListener('click', function() {
            submitPayment();
        });
    });

    function loadCartItems() {
        const cartItemsContainer = document.getElementById('cart-items');
        const savedCart = localStorage.getItem('pharmacy_cart');
        
        if (!savedCart) {
            window.location.href = '/pharmacy';
            return;
        }
        
        try {
            const cart = JSON.parse(savedCart);
            
            // Clear container
            cartItemsContainer.innerHTML = '';
            
            // Add cart items
            cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                
                const cartItemElement = document.createElement('div');
                cartItemElement.className = 'cart-item';
                
                if (item.image) {
                    cartItemElement.innerHTML = `
                        <img src="data:image/jpeg;base64,${item.image}" alt="${item.name}" class="cart-item-image">
                        <div class="cart-item-details">
                            <h5>${item.name}</h5>
                            <p>₹${item.price} × ${item.quantity} = ₹${itemTotal.toFixed(2)}</p>
                        </div>
                    `;
                } else {
                    cartItemElement.innerHTML = `
                        <div class="cart-item-image" style="background-color: #ddd; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-pills" style="font-size: 30px; color: #888;"></i>
                        </div>
                        <div class="cart-item-details">
                            <h5>${item.name}</h5>
                            <p>₹${item.price} × ${item.quantity} = ₹${itemTotal.toFixed(2)}</p>
                        </div>
                    `;
                }
                
                cartItemsContainer.appendChild(cartItemElement);
            });
            
        } catch (e) {
            console.error('Error loading cart from localStorage:', e);
            window.location.href = '/pharmacy';
        }
    }

    function submitPayment() {
        const utrId = document.getElementById('utr_id').value;
        const orderId = document.getElementById('order_id').value;
        
        if (!utrId) {
            alert('Please enter the UTR/Transaction ID');
            return;
        }
        
        showSpinner();
        
        // Submit payment
        fetch('/submit_cart_payment', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                order_id: orderId,
                utr_id: utrId
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            hideSpinner();
            if (data.success) {
                // Clear cart from localStorage
                localStorage.removeItem('pharmacy_cart');
                
                // Show success message
                const paymentStatus = document.querySelector('.payment-status');
                paymentStatus.classList.remove('payment-pending');
                paymentStatus.classList.add('payment-success');
                paymentStatus.innerHTML = '<i class="fas fa-check-circle"></i> Payment Status: Submitted for Verification';
                
                // Disable form
                document.getElementById('utr_id').disabled = true;
                document.getElementById('submit-payment').disabled = true;
                
                // Show success alert
                const alertElement = document.createElement('div');
                alertElement.className = 'alert alert-success alert-dismissible fade show';
                alertElement.role = 'alert';
                alertElement.innerHTML = `
                    <strong>Success!</strong> Your payment has been submitted for verification. You will be redirected to your orders page.
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                
                const mainContent = document.querySelector('.main-content');
                mainContent.insertBefore(alertElement, mainContent.firstChild);
                
                // Redirect to orders page after 5 seconds
                setTimeout(() => {
                    window.location.href = '/patient/orders';
                }, 5000);
            } else {
                alert(data.message || 'Something went wrong. Please try again.');
            }
        })
        .catch(error => {
            hideSpinner();
            console.error('Error:', error);
            alert('An error occurred. Please try again later.');
        });
    }
</script>
</body>
</html>